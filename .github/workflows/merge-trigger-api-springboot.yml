name: Send Code Changes on Push

on:
  push:
    branches:
      - QAPI_seer_stg
    paths:
      - 'QyrusEcommerceJavaBackend/**'
  pull_request:
    branches:
      - QAPI_seer_stg
    paths:
      - 'QyrusEcommerceJavaBackend/**'

jobs:
  send_code_changes:
    runs-on: runner-for-qyrus-public

    env:
      MONITORED_PATH: QyrusEcommerceJavaBackend

    steps:
      # 1) Checkout with full history
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      # 2) Compute commit range
      - name: Compute commit range & list
        id: range
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            FROM_SHA="${{ github.event.pull_request.base.sha }}"
            TO_SHA="${{ github.event.pull_request.head.sha }}"
          else
            FROM_SHA="${{ github.event.before }}"
            TO_SHA="${{ github.sha }}"
          fi

          echo "FROM_SHA=$FROM_SHA" >> $GITHUB_ENV
          echo "TO_SHA=$TO_SHA" >> $GITHUB_ENV

          COMMITS=$(git rev-list --reverse "${FROM_SHA}..${TO_SHA}")
          COMMITS_JSON=$(printf "%s\n" "$COMMITS" | jq -R -s -c 'split("\n")[:-1]')
          echo "commits=$COMMITS_JSON" >> $GITHUB_ENV

      # 3) Get code diff
      - name: Get code changes (diff)
        id: diff
        shell: bash
        run: |
          set -euo pipefail
          git diff "${FROM_SHA}..${TO_SHA}" -- "${MONITORED_PATH}" > changes.txt || true
          ENCODED_CHANGES=$(jq -Rs . < changes.txt)
          echo "encoded_changes=$ENCODED_CHANGES" >> $GITHUB_ENV

      # # 4) Get Gateway Token dynamically (now uses APP_URL secret)
      # - name: Get gateway token
      #   id: gateway
      #   shell: bash
      #   env:
      #     QAPI_ENVIRONMENT: ${{ secrets.QAPI_ENVIRONMENT }}
      #     AUTH_GATEWAY_TOKEN: ${{ secrets.AUTH_GATEWAY_TOKEN }}
      #     USERNAME: ${{ secrets.USERNAME }}
      #     PASSWORD: ${{ secrets.PASSWORD }}
      #     APP_URL: ${{ secrets.APP_URL }}
      #   run: |
      #     set -euo pipefail

      #     ENV_LOWER="$(echo "${QAPI_ENVIRONMENT:-}" | tr '[:upper:]' '[:lower:]')"
      #     if [[ "$ENV_LOWER" == "staging" ]]; then
      #       AUTH_URL="https://stg-gateway.qyrus.com:8243/authentication/v1/api/get-access-token"
      #     else
      #       AUTH_URL="https://gateway-uk.qyrus.com/authentication/v1/api/get-access-token"
      #     fi

      #     echo "APP URL $APP_URL"
      #     # Build auth body using APP_URL from secrets
      #     AUTH_BODY=$(jq -n \
      #       --arg applicationUrl "$APP_URL" \
      #       --arg email "$USERNAME" \
      #       --arg password "$PASSWORD" \
      #       '{applicationUrl:$applicationUrl, email:$email, password:$password, isSSO:false}')

      #     # Call authentication API
      #     AUTH_RESP=$(curl -sS -X POST "$AUTH_URL" \
      #       -H "Content-Type: application/json" \
      #       -H "Authorization: ${AUTH_GATEWAY_TOKEN}" \
      #       -d "$AUTH_BODY")
      #     echo "$AUTH_RESP"
      #     GATEWAY_URL=$(echo "$AUTH_RESP" | jq -r '.gatewayUrl // empty')
      #     GATEWAY_TOKEN=$(echo "$AUTH_RESP" | jq -r '.gatewayToken // empty')

      #     if [[ -z "$GATEWAY_URL" || -z "$GATEWAY_TOKEN" ]]; then
      #       echo "❌ Missing gatewayUrl/gatewayToken in response."
      #       echo "$AUTH_RESP" | jq 'del(.gatewayToken)'
      #       exit 1
      #     fi

      #     echo "gateway_url=$GATEWAY_URL" >> $GITHUB_ENV
      #     echo "gateway_token=$GATEWAY_TOKEN" >> $GITHUB_ENV
      #     echo "✅ Gateway authentication successful"

      # 5) Send diff and metadata to Impact Analyzer
      - name: Send changes to Analyze API
        shell: bash
        env:
          REPO_NAME: ${{ github.repository }}
          BRANCH_NAME: QAPI_seer_stg
          COMMIT_IDS: ${{ env.commits }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          ENCODED_CHANGES: ${{ env.encoded_changes }}
          USERNAME: ${{ secrets.USERNAME }}
          PASSWORD: ${{ secrets.PASSWORD }}
          WORKSPACE_NAME: ${{ secrets.WORKSPACE_NAME }}
          SUITE_NAME: ${{ secrets.SUITE_NAME }}
          ENVIRONMENT_NAME: ${{ secrets.ENVIRONMENT_NAME }}
          GATEWAY_URL: ${{ secrets.gateway_url }}
          GATEWAY_TOKEN: ${{ secrets.gateway_token }}
        run: |
          set -euo pipefail
          BASE="${GATEWAY_URL%/}"
          ANALYZE_URL="${BASE}/seer-api-java-impact-analyzer-producer/v1/analyze-test-impact"

          PAYLOAD=$(jq -n \
            --arg repo "$REPO_NAME" \
            --arg branch "$BRANCH_NAME" \
            --arg commits "$COMMIT_IDS" \
            --arg changes "$ENCODED_CHANGES" \
            --arg username "$USERNAME" \
            --arg password "$PASSWORD" \
            --arg workspace_name "$WORKSPACE_NAME" \
            --arg suite_name "$SUITE_NAME" \
            --arg environment_name "$ENVIRONMENT_NAME" \
            '{
              repository: $repo,
              branch: $branch,
              commit_ids: $commits,
              changes: $changes,
              username: $username,
              password: $password,
              workspace_name: $workspace_name,
              suite_name: $suite_name,
              environment_name: $environment_name
            }')

          echo "Posting to $ANALYZE_URL"
          HTTP_CODE=$(curl -sS -o response.json -w "%{http_code}" \
            -X POST "$ANALYZE_URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${GATEWAY_TOKEN}" \
            -H "GithubToken: $GH_TOKEN" \
            -d "$PAYLOAD")

          echo "Response Code: $HTTP_CODE"
          if [[ "$HTTP_CODE" -lt 200 || "$HTTP_CODE" -ge 300 ]]; then
            echo "❌ Error Response:"
            cat response.json
            exit 1
          fi

          echo "✅ Successfully sent changes"
