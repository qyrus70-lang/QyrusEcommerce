name: Send Code Changes on Push

on:
  pull_request:
    branches:
      - main
    paths:
      - 'QyrusEcommerceFrontend/**'

jobs:
  send_code_changes:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the code with full history
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Step 2: Get diff between PR base and head
      - name: Get Code Changes
        id: code_changes
        run: |
          # Get base and head from the PR event
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.sha }}

          # Generate diff
          git diff $BASE_SHA $HEAD_SHA > changes.txt

          # Encode diff safely for JSON
          ENCODED_CHANGES=$(jq -Rs . < changes.txt)
          echo "encoded_changes=$ENCODED_CHANGES" >> $GITHUB_ENV

      # Step 3: Send Changes to API
      - name: Send changes to API
        env:
          API_URL: https://testui-qyrusbot.qyrus.com/fluxdev/analyze-test-impact-agent/
          REPO_NAME: ${{ github.repository }}
          BRANCH_NAME: ${{ github.head_ref }}
          COMMIT_IDS: ${{ github.event.pull_request.commits }}
          ENCODED_CHANGES: ${{ env.encoded_changes }}
          QYRUS_USERNAME: ${{ secrets.QYRUS_USERNAME }}
          QYRUS_PASSWORD: ${{ secrets.QYRUS_PASSWORD }}
          QYRUS_TEAM_NAME: ${{ secrets.QYRUS_TEAM }}
          WEB_PROJECT_NAME: ${{ secrets.WEB_PROJECT_NAME }}
          WEB_RUN_CONFIGURATION_NAME: ${{ secrets.RUN_CONFIGURATION_NAME }}
        run: |
          PAYLOAD=$(jq -n \
            --arg repo "$REPO_NAME" \
            --arg branch "$BRANCH_NAME" \
            --arg commits "$COMMIT_IDS" \
            --arg changes "$ENCODED_CHANGES" \
            --arg qyrus_username "$QYRUS_USERNAME" \
            --arg qyrus_password "$QYRUS_PASSWORD" \
            --arg qyrus_team_name "$QYRUS_TEAM_NAME" \
            --arg web_project_name "$WEB_PROJECT_NAME" \
            --arg web_run_configuration_name "$WEB_RUN_CONFIGURATION_NAME" \
            '{
              repository: $repo,
              branch: $branch,
              commit_ids: $commits,
              changes: $changes,
              qyrus_username: $qyrus_username,
              qyrus_password: $qyrus_password,
              qyrus_team_name: $qyrus_team_name,
              web_project_name: $web_project_name,
              web_run_configuration_name: $web_run_configuration_name
            }')

          echo "Payload: $PAYLOAD"

          curl -X POST -H "Content-Type: application/json" \
            -d "$PAYLOAD" $API_URL
