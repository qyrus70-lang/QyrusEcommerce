name: Send Code Changes on Merge

on:
  push:
    branches:
      - main  # Replace with the branch you want to monitor for merges

jobs:
  send_code_changes:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the code with full history
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Ensure full history is fetched

      # Step 2: Debug the commit history
      - name: Debug Commit History
        run: |
          git log --oneline
          git rev-parse HEAD

      # Step 3: Get the code changes
      - name: Get Code Changes
        id: code_changes
        run: |
          if [ $(git rev-list --count HEAD) -eq 1 ]; then
            echo "Only one commit in history. Using HEAD for changes."
            PREV_SHA=$(git rev-parse HEAD)
          else
            PREV_SHA=$(git rev-parse HEAD~1)
          fi
          CURRENT_SHA=$(git rev-parse HEAD)

          # Get the diff and save it to a file
          git diff $PREV_SHA $CURRENT_SHA > changes.txt
          git diff $PREV_SHA $CURRENT_SHA > full_diff.txt

          # Export changes as an environment variable for API call
          echo "changes=$(cat changes.txt)" >> $GITHUB_ENV

      # Step 4: Send the code changes to your API
      - name: Send changes to API
        env:
          API_URL: https://testui-qyrusbot.quinnox.info/flux/analyze-test-impact/
        run: |
          # Read the diff from the file
          CHANGES=$(cat changes.txt)
          
          # Escape the diff for JSON
          ESCAPED_CHANGES=$(echo "$CHANGES" | jq -Rs .)
          
          # Construct the JSON payload
          PAYLOAD=$(jq -n \
            --arg branch "main" \
            --arg changes "$ESCAPED_CHANGES" \
            '{"branch": $branch, "changes": $changes}')
          
          # Debug the payload (optional)
          echo "Payload: $PAYLOAD"
          
          # Send the payload to the API
          curl -X POST -H "Content-Type: application/json" \
            -d "$PAYLOAD" $API_URL
